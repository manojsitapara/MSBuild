<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003" ToolsVersion="4.0">

  <PropertyGroup>
    <DbDeployOutputFileName>$(BuildDirForDbDeployOutput)\dbDeploy_output_$(CurrentDateTime).sql</DbDeployOutputFileName>
    <DbDeployUndoOutputFileName>$(BuildDirForDbDeployOutput)\dbDeploy_undo_$(CurrentDateTime).sql</DbDeployUndoOutputFileName>
  </PropertyGroup>

  <Target Name="GenerateSqlScriptFromDbDeploy">

    <PropertyGroup>
      <CurrentTargetName Condition="'$(CurrentTargetName)'!='GenerateSqlScriptFromDbDeploy'">GenerateSqlScriptFromDbDeploy</CurrentTargetName>
    </PropertyGroup>

    <Message Text="============= $(CurrentTargetName) target has been started. ============= " />

    <MSBuild.ExtensionPack.FileSystem.Folder
           TaskAction="RemoveContent"
           Path="$(DeploymentDirForDbDeploy)"/>

    <MSBuild.ExtensionPack.FileSystem.Folder
            TaskAction="RemoveContent"
            Path="$(BuildDirForDbDeployOutput)"/>


    <MSBuild.Dbdeploy.Task.Dbdeploy
            DbType="mssql"
            templatedir="$(DbDeployTemplateDir)"
            DbConnection="$(DatabaseConnectionString)"
            Dir="$(BuildDirForDbDeploy)"
            OutputFile="$(DbDeployOutputFileName)"
            UndoOutputFile="$(DbDeployUndoOutputFileName)"
            TableName="$(DatabaseChangeLogTableName)"
            AutoCreateChangeLogTable="true"
            forceUpdate="true"  />


    <WriteLinesToFile File="$(TempDbDeployFile)" Lines="$(DbDeployOutputFileName)" Overwrite="true" Condition="$(PushCodeToDestination) == 'false' "/>

    <Message Text="============= $(CurrentTargetName) target has been completed. ============= " />

    <OnError ExecuteTargets="SendEmailNotification" Condition="$(AllowEmailNotification)=='true'"  />
  </Target>


  <Target Name="UpdateDestinationDatabase">


    <ItemGroup Condition="$(PushCodeToDestination) == 'true' ">
      <dbDeployFileName Include="$(TempDir)\dbDeployFileName.txt"/>
    </ItemGroup>

    <ReadLinesFromFile File="@(dbDeployFileName)" Condition="$(PushCodeToDestination) == 'true' ">
      <Output TaskParameter="Lines" ItemName="dbDeployOutputFilePath" />
    </ReadLinesFromFile>

    <PropertyGroup>
      <CurrentTargetName Condition="'$(CurrentTargetName)'!='UpdateDestinationDatabase'">UpdateDestinationDatabase</CurrentTargetName>
      <SqlCmdInputFile>$(DbDeployOutputFileName)</SqlCmdInputFile>
      <SqlCmdInputFile Condition="$(PushCodeToDestination) == 'true' ">@(dbDeployOutputFilePath)</SqlCmdInputFile>
    </PropertyGroup>

    <Message Text="============= $(CurrentTargetName) target has been started. ============= " />

    <Message Text="Executing change script ($(GenerateOutputSqlFileName)) on $(dbDeployDBName) ..."/>

    <MSBuild.ExtensionPack.SqlServer.SqlCmd
      TaskAction="Execute"
      Server="$(SqlServerName)"
      Database="$(dbDeployDBName)"
      LogOn="$(SqlServerUserName)"
      Password="$(SqlServerPassword)"
      InputFiles="$(SqlCmdInputFile)"
      Condition="$(IsSqlWindowsAuthentication)=='false'"/>

    <MSBuild.ExtensionPack.SqlServer.SqlCmd
      TaskAction="Execute"
      Server="$(SqlServerName)"
      Database="$(dbDeployDBName)"
      InputFiles="$(SqlCmdInputFile)"
      Condition="$(IsSqlWindowsAuthentication)=='true'"/>



    <Message Text="============= $(CurrentTargetName) target has been completed. ============= " />

    <OnError ExecuteTargets="SendEmailNotification" Condition="$(AllowEmailNotification)=='true'"  />
  </Target>




</Project>