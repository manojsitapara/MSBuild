<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003" ToolsVersion="4.0">

  <Target Name="GenerateSqlScriptFromDbDeploy">

    <PropertyGroup>
      <CurrentTargetName Condition="'$(CurrentTargetName)'!='GenerateSqlScriptFromDbDeploy'">GenerateSqlScriptFromDbDeploy</CurrentTargetName>
      <DbDeployOutputFileName>$(BuildDirForDbDeployOutput)\dbDeploy_output_$(CurrentDateTime).sql</DbDeployOutputFileName>
      <DbDeployUndoOutputFileName>$(BuildDirForDbDeployOutput)\dbDeploy_undo_$(CurrentDateTime).sql</DbDeployUndoOutputFileName>
    </PropertyGroup>

    <Message Text="============= $(CurrentTargetName) target has been started. ============= " />


    <MSBuild.ExtensionPack.FileSystem.Folder
            TaskAction="RemoveContent" 
            Path="$(BuildDirForDbDeployOutput)"/>
    
    
    <MSBuild.Dbdeploy.Task.Dbdeploy
            DbType="mssql"
            templatedir="$(DbDeployTemplateDir)"
            DbConnection="$(DatabaseConnectionString)"
            Dir="$(BuildDirForDbDeploy)"
            OutputFile="$(DbDeployOutputFileName)"
            UndoOutputFile="$(DbDeployUndoOutputFileName)"
            TableName="$(DatabaseChangeLogTableName)"
            AutoCreateChangeLogTable="true"
            forceUpdate="true"  />


    
    <Message Text="============= $(CurrentTargetName) target has been completed. ============= " />

    <OnError ExecuteTargets="SendEmailNotification" Condition="$(AllowEmailNotification)=='true'"  />
  </Target>

  
  <Target Name="DatabaseDeployment" DependsOnTargets="GenerateSqlScriptFromDbDeploy">
    
    <PropertyGroup>
      <CurrentTargetName Condition="'$(CurrentTargetName)'!='DatabaseDeployment'">DatabaseDeployment</CurrentTargetName>
      <DbDeployFileToRun>$(DeploymentDir)\$(DbDeployScriptFolderName)\dbDeploy_output_$(CurrentDateTime).sql</DbDeployFileToRun>
    </PropertyGroup>
    
    <Message Text="============= $(CurrentTargetName) target has been started. ============= " />
    
    <Message Text="Executing change script ($(GenerateOutputSqlFileName)) on $(dbDeployDBName) ..."/>

    <MSBuild.ExtensionPack.SqlServer.SqlCmd 
      TaskAction="Execute" 
      Server="$(SqlServerName)" 
      Database="$(dbDeployDBName)" 
      LogOn="$(SqlServerUserName)" 
      Password="$(SqlServerPassword)" 
      InputFiles="$(DbDeployFileToRun)"  
      Condition="$(IsSqlWindowsAuthentication)=='false'"/>

    <MSBuild.ExtensionPack.SqlServer.SqlCmd 
      TaskAction="Execute" 
      Server="$(SqlServerName)" 
      Database="$(dbDeployDBName)" 
      InputFiles="$(DbDeployFileToRun)"  
      Condition="$(IsSqlWindowsAuthentication)=='true'"/>

    
    
    <Message Text="============= $(CurrentTargetName) target has been completed. ============= " />

    <OnError ExecuteTargets="SendEmailNotification" Condition="$(AllowEmailNotification)=='true'"  />
  </Target>


  

</Project>